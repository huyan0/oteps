# OTLP Export  Behavior
 OTLP exporters supports configurable behaviors.

 They are exporting cumulative values since startup by default, and exporting delta values per collection interval and when configured. 

## Motivation 

1. Metric backends such as Prometheus and Prometheus Remote Write integrated storages requires cumulative values for cumulative/adding metrics rather than delta value per collection interval. Thus, to export metrics generated by the SDK using the collector, incoming values from the SDK should be in cumulative form.

2. Cumulative export also address the problem of a lost delta value of a UpDownCounter. The final consumer of the UpDownCounter metrics is almost always interested in the cumulative value. If Metric SDKs exports deltas and let the consumer aggregate to cumulative values, then any delta lost in-transit leads to inaccurate final value; this may impact an alert is fired or not. On the other hand, exporting cumulative values guarantees only resolution is lost, but the value received by the final consumer will be correct eventually.

  

Addressed issues: spec [#731](https://github.com/open-telemetry/opentelemetry-specification/issues/731), [#725](https://github.com/open-telemetry/opentelemetry-specification/issues/725)
Sig meeting discussion: [Metrics SIG](https://docs.google.com/document/d/1LfDVyBJlIewwm3a0JtDtEjkusZjzQE3IAix8b0Fxy3Y/edit#heading=h.fxqkpi2ya3br) July 23, July 30

## Explanation

To support Prometheus as well as delta backends, the SDK should be configurable and supports OTLP exporter to have both cumulative default or delta export behavior. The current OTLP metrics defined in [PR #193](https://github.com/open-telemetry/opentelemetry-proto/pull/193) provides support for both strategy. 

Users should be allowed to declare an environment variable or configuration field that determines this setting for OTLP exporter.
 

## Internal details
OTLP exporters can report the strategy it desires to the Metric SDK, and the SDK can merge the previous state of metrics with current value and return the appropriate values to the exporter.  
  
The machinery for configurable export behavior is already demonstrated by the Metrics Processor component in [Go SDK](https://github.com/open-telemetry/opentelemetry-go/pull/840).

## Trade-offs and mitigations

 To support cumulative export strategy, the SDK needs to maintain state of each cumulative metrics. This means users with high-cardinality metrics can experience high memory usage. 
 
This problem could be addressed by adding support in the Collector, when configured as an Agent, to support converting delat OTLP to Cumulative OTLP, but this requires a single agent for each metric generating client so that all delta values of a metric are converted at the same location. 


## Prior art and alternatives

A prior solution to convert deltas to cumulative is to add the implementation in the collector to support both collector as an Agent and a standalone service. Supporting conversion in collector as a standalone service requires routing mechanism across collectors to ensure delta values of the same cumulative metrics is aggregated correctly. 
 

## Open questions
As stated in the previous section, delta to cumulative conversion in the collector is needed. This probably will be necessary in the collector in the future because the collector might also accept metrics from other sources that reports delta values. 

How the conversion in the collector would be implemented and supported in the future is still under discussion, and a proposal is to add a Metric Aggregation collector
  

## Future possibilities
Dynamic configuration from could be supported in the future for the OTLP client to determine the appropriate export strategy at startup.
